# version: '3.8' (Opcional en versiones nuevas de Docker)
networks:
  mynetwork:
    driver: bridge

services:
  # ğŸ§© Laravel principal (Front, Usuarios, Auth)
  my-chat:
    build:
      context: ./mmy-chat
      dockerfile: Dockerfile
    ports:
      - '8020:8020'
      - '5173:5173'
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8020" ]
      interval: 30s
      timeout: 10s
      retries: 5
    command: [ "php", "artisan", "serve", "--host=0.0.0.0", "--port=8020" ]
    environment:
      # Base de datos
      DB_HOST: users-db
      DB_PORT: 5432
      DB_USERNAME: root
      DB_PASSWORD: root
      DB_DATABASE: users

      # ConfiguraciÃ³n Reverb / Broadcasting
      BROADCAST_DRIVER: reverb
      # Apuntamos al nombre del servicio 'reverb'
      REVERB_HOST: reverb
      REVERB_PORT: 8080
      REVERB_SCHEME: http
      # Redis para gestiÃ³n de colas/eventos
      REDIS_HOST: redis
      REDIS_PORT: 6379
    volumes:
      - './mmy-chat:/var/www'
    depends_on:
      - users-db
      - redis
    restart: unless-stopped
    networks:
      - mynetwork

  # ğŸ”Š Reverb Centralizado (Ãšnico servidor WebSocket)
  reverb:
    build:
      context: ./mmy-chat # Usa el cÃ³digo de mmy-chat para arrancar el servidor
      dockerfile: Dockerfile.reverb
    # IMPORTANTE: --host=0.0.0.0 para que acepte conexiones externas
    command: [ "php", "artisan", "reverb:start", "--host=0.0.0.0", "--port=8080" ]
    ports:
      - "8080:8080"
    depends_on:
      users-db:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      DB_HOST: users-db
      DB_PORT: 5432
      DB_USERNAME: root
      DB_PASSWORD: root
      DB_DATABASE: users

      # ConfiguraciÃ³n de Reverb para usar Redis
      REVERB_SCALING_ENABLED: "true"
      REVERB_REDIS_HOST: redis
      REVERB_REDIS_PORT: 6379
      # AsegÃºrate de que estas claves coincidan en TODOS los .env
      # APP_ID, APP_KEY, APP_SECRET deben ser iguales en my-chat y chat-service
    restart: unless-stopped
    networks:
      - mynetwork

  # ğŸ—„ï¸ Base de datos para MyChat
  users-db:
    image: postgres:latest
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root"]
      interval: 10s
      timeout: 5s
      retries: 5
    ports:
      - '5432:5432'
    volumes:
      - './data:/var/lib/postgresql/data'
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: users
    networks:
      - mynetwork

  # ğŸ’¬ Microservicio de MensajerÃ­a (DDD + Doctrine)
  chat-service:
    build:
      context: ./chat-service
      dockerfile: Dockerfile
    ports:
      - '8030:8030'
      # Puerto 8081 ELIMINADO (Ya no hostea websockets)
    healthcheck:
      # Si tienes curl instalado en el Dockerfile descomenta esto:
      test: [ "CMD", "curl", "-f", "http://localhost:8030" ]
      # Si no, usa un comando bÃ¡sico de php:
      # test: ["CMD", "php", "artisan", "help"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    environment:
      PHP_IDE_CONFIG: serverName=chat-service
      # DB Message
      DB_HOST: messages-db
      DB_PORT: 5432
      DB_USERNAME: chatuser
      DB_PASSWORD: chatpass
      DB_DATABASE: messages

      # ConfiguraciÃ³n Broadcasting (Para enviar eventos al servicio reverb)
      BROADCAST_DRIVER: reverb
      REVERB_HOST: reverb   # Nombre del servicio Docker
      REVERB_PORT: 8080
      REVERB_SCHEME: http
      REVERB_REDIS_HOST: redis
      REVERB_REDIS_PORT: 6379
    volumes:
      - './chat-service:/var/www'
    # Comando simplificado, solo API
    command: [ "php", "artisan", "serve", "--host=0.0.0.0", "--port=8030" ]
    depends_on:
      messages-db:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - mynetwork

  # ğŸ—„ï¸ Base de datos para ChatService
  messages-db:
    image: postgres:latest
    restart: always
    ports:
      - '5433:5432'
    volumes:
      - './chat-data:/var/lib/postgresql/data'
    environment:
      POSTGRES_USER: chatuser
      POSTGRES_PASSWORD: chatpass
      POSTGRES_DB: messages
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U chatuser" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mynetwork

  # ğŸ§­ pgAdmin
  pgadmin:
    image: dpage/pgadmin4
    ports:
      - '8082:80'
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    volumes:
      - ./pgadmin-data:/var/lib/pgadmin
    depends_on:
      - users-db
      - messages-db
    networks:
      - mynetwork

  # ğŸ§  Redis (Corregido para Windows)
  redis:
    image: redis:alpine
    ports:
      - "7000:6379" # Host 7000 -> Contenedor 6379 (Correcto)
    volumes:
      - ./redis-data:/data
    networks:
      - mynetwork

  # ğŸŒ NGINX
  nginx:
    image: nginx:latest
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - reverb
      - chat-service
      - my-chat
    networks:
      - mynetwork
